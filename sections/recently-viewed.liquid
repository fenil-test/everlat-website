{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}
{{ 'component-slider.css' | asset_url | stylesheet_tag }}
{{ 'template-collection.css' | asset_url | stylesheet_tag }}

<script>
    // Function to set recently viewed products
    function setRecentlyViewedPdp() {
        const pdpData = {
            productTitle: "{{ product.title }}",
            productImg: "{{ product.featured_image | img_url: '500x' }}",
            productIds: "{{ product.id }}",
            productVariantImage: [
                {% for variant in product.variants %}
                    "{{ variant.featured_image.src | image_url }}"{% if forloop.last %}{% else %},{% endif %}
                {% endfor %}
            ],
            productPrice: "{{ product.price | money }}",
            productUrl: "{{ product.url }}",
            productColorVariants: [
                {% for variant in product.variants %}
                    "{{ variant.option1 }}"{% if forloop.last %}{% else %},{% endif %}
                {% endfor %}
            ],
        };

        const productArr = [];
        let jsonResp, jsonRespArr, jsonRespArrStr;
        const numberOfProduct = 4;
        productArr.push(pdpData);
        const currPdpTitle = pdpData.productTitle;
        const pdpDataString = JSON.stringify(productArr);
        const localData = localStorage.getItem('recently_viewed');

        if (localData == null) {
            localStorage.setItem('recently_viewed', pdpDataString);
        } else {
            const oldPdpData = localStorage.getItem('recently_viewed');
            console.log("oldPdpData", oldPdpData);
            
            // Parse oldPdpData to extract product IDs
            const oldPdpDataParsed = JSON.parse(oldPdpData);

            const countPdpData = (oldPdpData.match(/productTitle/g) || []).length;
            const reVisitPdp = oldPdpData.includes(currPdpTitle);
            if (countPdpData < numberOfProduct && !reVisitPdp) {
                jsonResp = JSON.parse(oldPdpData);
                jsonRespArr = jsonResp.concat(productArr);
                jsonRespArrStr = JSON.stringify(jsonRespArr);
                localStorage.setItem('recently_viewed', jsonRespArrStr);
            } else if (countPdpData >= numberOfProduct && !reVisitPdp) {
                jsonResp = JSON.parse(oldPdpData);
                jsonResp.shift();
                jsonRespArr = jsonResp.concat(productArr);
                jsonRespArrStr = JSON.stringify(jsonRespArr);
                localStorage.setItem('recently_viewed', jsonRespArrStr);
            }
        }
    }

    setRecentlyViewedPdp();
</script>

<div class="recently-title page-width">
    <h4 class="text-upper title inline-richtext scroll-trigger animate--slide-in mt-0 mb-15">Recently Viewed</h4>
</div>
<div class="page-width">
    <div class="js-recentPdpBlock grid product-grid grid--4-col-desktop grid--2-col-tablet-down"></div>
</div>

<script>
    // Function to get recently viewed products
    function getRecentPdp() {
        const pdpData = JSON.parse(localStorage.getItem('recently_viewed')) || [];
        const recentViewHtml = [];

        pdpData.forEach(function(item, i) {

            if (!item.productColorVariants || !item.productVariantImage) {
                console.error("Missing product color variants or variant images.");
                return;
            }

            let colorImageMap = {};
            item.productColorVariants.forEach((color, index) => {
                if (item.productVariantImage[index]) {
                    colorImageMap[color] = item.productVariantImage[index];
                } else {
                    colorImageMap[color] = ''; // Default to empty string if no image available
                }
            });

            let uniq_product_color = [...new Set(item.productColorVariants)];

            let colorHtml = uniq_product_color.map((color) => 
            `
            <span
              class="color-selector"
              data-product-id="${ item.productIds }"
              data-color="${color}"
              data-image="${colorImageMap[color]}"
              style="background:${color};"
            >
            </span>
            `).join('');

            recentViewHtml.push(`
                <li
                    id="Slide-{{ section.id }}-{{ forloop.index }}"
                    class="grid__item{% if show_mobile_slider or show_desktop_slider %} slider__slide{% endif %}{% if settings.animations_reveal_on_scroll %} scroll-trigger animate--slide-in{% endif %}"
                    {% if settings.animations_reveal_on_scroll %}
                    data-cascade
                    style="--animation-order: {{ forloop.index }};"
                    {% endif %}
                >
                    {% render 'card-product-view', 
                        product_url: "${item.productUrl}",
                        product_img: "${item.productImg}",
                        product_title: "${item.productTitle}",
                        product_price: "${item.productPrice}",
                        product_colors: "${colorHtml}"

                    %}
                </li>
            `);
        });

        const recentBlock = `${recentViewHtml.join('')}`;
        const contentBlock = document.querySelectorAll('.js-recentPdpBlock');
        contentBlock.forEach(element => {
            element.innerHTML = recentBlock;
        });
    }

    document.addEventListener('DOMContentLoaded', getRecentPdp);
</script>

{% schema %}
{
  "name": "Recently product view",
  "tag": "section",
  "class": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [],
  "presets": [
    {
      "name": "Recently product view"
    }
  ]
}
{% endschema %}
